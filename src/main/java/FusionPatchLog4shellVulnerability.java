import org.apache.commons.io.FileUtils;

import java.io.File;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;
import java.util.Objects;
import java.util.Set;
import java.util.TreeSet;
import java.util.regex.Pattern;
import java.util.stream.Stream;

public class FusionPatchLog4shellVulnerability {

  static Pattern affectedJarPattern = Pattern.compile("log4j.*-2\\..*\\.jar");
  static Pattern cpAffectedJarPattern = Pattern.compile("apps/libs/log4j.*-2\\..*\\.jar");

  static Pattern affectedLog4jConfigPattern = Pattern.compile(".*log4j.*\\.(xml|properties)");
  static String affectedLog4jConfigText = "%m%n";
  static String log4jConfigTextFixed = "%m{nolookups}%n";

  public static void main(String[] args) throws Exception {
    File fusionHome;
    if (args.length == 0) {
      fusionHome = new File(".");
    } else {
      fusionHome = new File(args[0]);
    }

    System.out.println("This program will patch your Fusion 3.x or 4.x installation for log4jshell vulnerability CVE-2021-44228");
    System.out.println("Fusion directory: " + fusionHome.getCanonicalPath());

    File fusionBuild = new File(fusionHome, "fusion.build");
    if (!fusionBuild.exists()) {
      System.out.println("ERROR: Fusion build file " + fusionBuild + " not found. The does not appear to be a valid Fusion installation.");
      System.exit(1);
    }

    Set<String> affectedFiles = new TreeSet<>();

    try (Stream<Path> walkStream = Files.walk(fusionHome.toPath())) {
      walkStream.filter(p -> p.toFile().isFile()).forEach(f -> {
        if (affectedJarPattern.matcher(f.getFileName().toString()).matches()) {
          String affectedFile = f.getFileName().toString();
          String affectedArtifact = affectedFile.substring(0, affectedFile.lastIndexOf("-"));
          String[] affectedVersion = affectedFile.substring(affectedFile.lastIndexOf("-") + 1, affectedFile.lastIndexOf(".")).split("\\.");
          if (Integer.parseInt(affectedVersion[1]) < 15) {
            System.out.println("Affected file found: " + f);
            affectedFiles.add(affectedFile);
            try {
              File newArtifact = new File(f.toFile().getParentFile(), affectedArtifact + "-2.15.0.jar");
              System.out.println("Copying patched jar file: " + newArtifact);
              FileUtils.copyInputStreamToFile(Objects.requireNonNull(FusionPatchLog4shellVulnerability.class.getResourceAsStream("jars/" + affectedArtifact + "-2.15.0.jar")), newArtifact);
            } catch (IOException e) {
              throw new RuntimeException(e);
            }
            System.out.println("Deleting vulnerable jar file: " + f);
            if (!f.toFile().delete()) {
              System.out.println("Could not delete vulnerable file: " + f);
              System.exit(1);
            }
          }
        }
      });
    }

    System.out.println("Vulnerable jars updated:");
    if (affectedFiles.isEmpty()) {
      System.out.println("  (None found)");
    }
    for (String affectedFile : affectedFiles) {
      System.out.println("  " + affectedFile);
    }

    patchExtraClasspathTextFile(Paths.get(fusionHome.getAbsolutePath(), "apps", "jetty", "api", "webapps", "api-extra-classpath.txt").toFile());
    patchExtraClasspathTextFile(Paths.get(fusionHome.getAbsolutePath(), "apps", "jetty", "connectors-classic", "webapps", "connectors-extra-classpath.txt").toFile());

    try (Stream<Path> walkStream = Files.walk(fusionHome.toPath())) {
      walkStream.filter(p -> p.toFile().isFile()).forEach(f -> {
        if (affectedLog4jConfigPattern.matcher(f.getFileName().toString()).matches()) {
          try {
            String xml = FileUtils.readFileToString(f.toFile(), StandardCharsets.UTF_8);
            if (xml.contains(affectedLog4jConfigText)) {
              FileUtils.writeStringToFile(f.toFile(), xml.replace(affectedLog4jConfigText, log4jConfigTextFixed), StandardCharsets.UTF_8);
              System.out.println("Updated vulnerable log4j2 config file " + f);
            }
          } catch (IOException e) {
            throw new RuntimeException(e);
          }
        }
      });
    }

    System.out.println("Update complete.");
  }

  private static void patchExtraClasspathTextFile(File extraClasspath) throws IOException {
    if (!extraClasspath.exists()) {
      return;
    }
    System.out.println("Updating " + extraClasspath + " if needed...");
    int updated = 0;
    List<String> lines = FileUtils.readLines(extraClasspath, StandardCharsets.UTF_8);
    for (int i = 0; i < lines.size(); ++i) {
      String line = lines.get(i);
      if (cpAffectedJarPattern.matcher(line).matches()) {
        String affectedArtifact = line.substring(0, line.lastIndexOf("-"));
        String[] affectedVersion = line.substring(line.lastIndexOf("-") + 1, line.lastIndexOf(".")).split("\\.");
        if (Integer.parseInt(affectedVersion[1]) < 15) {
          String newArtifact = affectedArtifact + "-2.15.0.jar";
          System.out.println("  Replacing " + line + " with " + newArtifact);
          lines.set(i, newArtifact);
          ++updated;
        }
      }
    }
    FileUtils.writeLines(extraClasspath, lines);
    System.out.println("  -- updated " + updated + " lines.");
  }
}
